---
title: "Common-CDR3"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '/Users/HP/Desktop/Third-Sem/DataScienceCapstoneProject/Data/ProcessedData')
```

```{r}
library(tidyverse)
library(stringr)
library(dplyr)
library(reshape)
library(RColorBrewer)
library(pheatmap)
library(ggplot2)
```

# Import all files
```{r}
PATH <- "/Users/HP/Desktop/Third-Sem/DataScienceCapstoneProject/Data/ProcessedData"
PATH1 <- "/Users/HP/Desktop/Third-Sem/DataScienceCapstoneProject/Data/Output"

  # List of the file names 
  files_list <- list.files(path = PATH, pattern = "*.tsv")

  # Read all files 
  all_files <- lapply(files_list, function(x){
  read.table(file = x,
             sep = '\t',
             header = TRUE, 
             na.strings = c('', 'NA'))
   })
# Reference the files by name
names(all_files) <- files_list

yr1 ="2016"
yr2 ="2017"
d0="d0"
d7="d7"
stage1 = "res"
stage2 = "act"
list1<-list("Sbj_05","Sbj_06","Sbj_08","Sbj_10","Sbj_11","Sbj_14")
```

# Split based on GeneName (4D and 2D) 
```{r}

SplitGeneName <- function(str){
  count = 0
  for (i in 1:length(all_files)){
       subject <- substr(files_list[i], 1, 6)
       if(subject == str & count < 6){
       count = count+1
       year <- substr(files_list[i], 15, 18)
       day <- substr(files_list[i], 8, 9)
       status <- substr(files_list[i], 11, 13)
       if( year == yr1 & day == d0 & status == stage1){
           d0_res_2016 <- all_files[[i]]
       }else if( year == yr1 & day == d7 & status == stage2){
            d7_act_2016 <- all_files[[i]]
       }else if(year == yr2 & day == d7 & status == stage1){
            d7_res_2017 <- all_files[[i]]
       }else if(year == yr1 & day == d0 & status == stage2){
            d0_act_2016 <- all_files[[i]] 
       }else if(year == yr2 & day == d0 & status == stage1){
            d0_res_2017 <- all_files[[i]]
       }else if(year == yr2 & day == d7 & status == stage2){
            d7_act_2017 <- all_files[[i]]
       }else if(year == yr2 & day == d0 & status == stage2){
            d0_act_2017 <- all_files[[i]]
       }else if( year == yr1 & day == d7 & status == stage1){
            d7_res_2016 <- all_files[[i]] 
       }

       }
}
CR<-cross_reactive(d7_act_2016,d7_act_2017)
CR$Subject <- str
write.table(CR, file=paste0(PATH1,"/cross-reactive.tsv"),row.names = FALSE,sep='\t',append=TRUE, col.names = FALSE)
COM<- btwtimepoint(d0_res_2016,d7_act_2016,d0_res_2017,d7_act_2017)
COM$Subject <- str
write.table(COM, file=paste0(PATH1,"/timepoints.tsv"),row.names = FALSE,sep='\t',append=TRUE, col.names = FALSE)
ACT<- activetwoyear(d0_act_2016,d7_act_2016,d0_act_2017,d7_act_2017)
if(count(ACT)!=0){
ACT$Subject <- str
write.table(ACT, file=paste0(PATH1,"/activetwoyears.tsv"),row.names = FALSE,sep='\t',append=TRUE, col.names = FALSE)
}
}

```

# Finding boosted CDR3 cells in 2017

```{r}
cross_reactive <- function(df1,df2,str){
  # boosted CDR3 cells in 4-digit gene families in 2017 
  cross_act_act_d7 <- merge(df1[,1:3],df2[,1:3], by=c("aminoAcid","vGeneName"))
  names(cross_act_act_d7)[3:4] <- c('Count-2016','Count-2017') 
  # Absolute change of boosted CDR3 cells in 4-digit gene families from 2016 to 2017 
  cross_act_act_d7$diff <- abs(cross_act_act_d7$`Count-2017`- cross_act_act_d7$`Count-2016`)
  return(cross_act_act_d7)
  }
```

# Finding common CDR3 between time points 

```{r}
btwtimepoint<- function(df1,df2,df3,df4){
tryCatch({
   # Activated cells between d0 and d7 in 2016
   do_rest_act_2016 <- merge(df1[,1:3],df2[,1:3], by=c("aminoAcid","vGeneName"))
   names(do_rest_act_2016)[3:4] <- c('RestCount','ActiveCount')
   do_rest_act_2016$diff <- abs(do_rest_act_2016$`ActiveCount`-do_rest_act_2016$`RestCount`)
   do_rest_act_2016$Year <- yr1
   },
   error = function(err) {
   do_rest_act_2016 <- NULL
    })
   # Activated cells between d0 and d7 in 2017
  tryCatch({
   do_rest_act_2017 <- merge(df3[,1:3],df4[,1:3], by=c("aminoAcid","vGeneName"))
   names(do_rest_act_2017)[3:4] <- c('RestCount','ActiveCount')
   do_rest_act_2017$diff <- abs(do_rest_act_2017$`ActiveCount`-do_rest_act_2017$`RestCount`)
   do_rest_act_2017$Year <- yr2
   },
   error = function(err) {
   do_rest_act_2017 <- NULL
  })
  do_rest_act = rbind(do_rest_act_2016,do_rest_act_2017)
  return(do_rest_act)
}
```


# Finding active CDR3 across two years
```{r}
activetwoyear<- function(df1,df2,df3,df4){
  
  act_act_2016 <- merge(df1[,1:3],df2[,1:3], by=c("aminoAcid","vGeneName"))
  names(act_act_2016)[3:4] <- c('ActiveD0-2016','ActiveD7-2016')
  act_act_2017 <- merge(df3[,1:3],df4[,1:3], by=c("aminoAcid","vGeneName"))
  names(act_act_2017)[3:4] <- c('ActiveD0-2017','ActiveD7-2017')
  
  tryCatch({
  act2year <- merge(act_act_2016[,1:4],act_act_2017[,1:4], by=c("aminoAcid","vGeneName"))
  },error = function(err){
   act2year <- NULL
  })
  return(act2year)
  }
```

# Calling six subjects 
```{r}
file1 = paste0(PATH1,"/cross-reactive.tsv")
file2 = paste0(PATH1,"/timepoints.tsv")
file3 = paste0(PATH1,"/activetwoyears.tsv")

  #Check its existence
if(file.exists(file1)) {
  #Delete file if it exists
    file.remove(file1)
}
if(file.exists(file2)){
    file.remove(file2)
  }
if(file.exists(file3)){
    file.remove(file3)
  }
for (k in 1:length(list1)){
  SplitGeneName(list1[[k]])
  }
 
```

# Adding colnames to the files
```{r}
df1<-read.table(file1,header=FALSE,sep='\t')
df2<-read.table(file2,header=FALSE,sep='\t')
df3<-read.table(file3,header=FALSE,sep='\t')
colnames(df1) <- c("aminoAcid","vGeneName","Count-2016","Count-2017","Difference","Subject")
colnames(df2) <- c("aminoAcid","vGeneName","RestCount","ActiveCount","Difference","Year","Subject")
colnames(df3) <- c("aminoAcid","vGeneName","ActiveD0-2016","ActiveD7-2016","ActiveD0-2017","ActiveD7-2017")
tryCatch({
write.table(df1,file=paste0(PATH1,"/cross-reactive.tsv"),sep='\t',col.names = TRUE)
write.table(df2,file=paste0(PATH1,"/timepoints.tsv"),sep='\t',col.names = TRUE)
write.table(df3,file=paste0(PATH1,"/activetwoyears.tsv"),sep='\t',col.names = TRUE)
},
warning = function(war) {
   print("Files Modified")
})

```


```{r}
df1<-read.table(paste0(PATH1,"/cross-reactive.tsv"),sep='\t',header=TRUE)
df2<-read.table(paste0(PATH1,"/timepoints.tsv"),sep='\t',header=TRUE)
df1$aminoAcid <- paste0(df1$aminoAcid," (", df1$Subject," )")
df2$aminoAcid <- paste0(df2$aminoAcid," (", df2$Subject," )")
df1$vGeneName <- paste0(df1$vGeneName," (", df1$Subject," )")
df2$vGeneName <- paste0(df2$vGeneName," (", df2$Subject," )")
str1<- c("aminoAcid","vGeneName","Difference")
```

#sorting the cross_4d in the decreasing order of Difference and selecting the first 10 from the dataset.
```{r}
cross_4d<- df1[grepl("\\-",df1$vGeneName,perl = TRUE),str1]
cross_2d <- df1[!grepl("\\-",df1$vGeneName,perl = TRUE),str1]
attach(cross_4d)
cross_4d<- cross_4d[order(-Difference),]
cross_4d<- cross_4d[1:10,]
detach(cross_4d)
```

#sorting the cross_2d in the decreasing order of Difference and selecting the first 5 from the dataset.
```{r}
attach(cross_2d)
cross_2d<- cross_2d[order(-Difference),]
cross_2d<-cross_2d[1:10,]
detach(cross_2d)
```

# increased cross reactive cdr3s from 2016 to 2017
```{r}
increase_cross_reactive <- subset(df1,df1$Count.2017 > df1$Count.2016,c("aminoAcid","vGeneName","Difference"))
attach(increase_cross_reactive)
increase_cross_reactive <- increase_cross_reactive[order(-Difference),]
#increase_cross_reactive
detach(increase_cross_reactive)
write.table(increase_cross_reactive, file=paste0(PATH1,"/increased_cross_reactive.tsv"),row.names = FALSE,sep='\t', col.names = TRUE)
increase_cross_reactive <- increase_cross_reactive[1:10,]
```

# increased cdr3s between time points across two years
```{r}
increase_timepoint <- subset(df2,df2$ActiveCount > df2$RestCount,c("aminoAcid","vGeneName","Difference","Year"))
attach(increase_timepoint)
increase_timepoint <- increase_timepoint[order(-Difference),]
#increase_timepoint
detach(increase_timepoint)
write.table(increase_timepoint, file=paste0(PATH1,"/increased_btw_timepoints.tsv"),row.names = FALSE,sep='\t', col.names = TRUE)
increase_timepoint_4D<- increase_timepoint[grepl("\\-",increase_timepoint$vGeneName,perl = TRUE),]
increase_timepoint_2D <- increase_timepoint[!grepl("\\-",increase_timepoint$vGeneName,perl = TRUE),]
increase_timepoint_4D <-increase_timepoint_4D[1:10,]
increase_timepoint_2D <- increase_timepoint_2D[1:10,]
```

#sorting timepoint_4d_2016 in decreasing order of Difference and selecting the first 10 from dataset.
```{r}
timepoint_4d<- df2[grepl("\\-",df2$vGeneName,perl = TRUE),c("aminoAcid","vGeneName","Difference","Year")]
timepoint_4d_yr1<- timepoint_4d[timepoint_4d$Year== yr1,]
attach(timepoint_4d_yr1)
timepoint_4d_yr1<- timepoint_4d_yr1[order(-Difference),]
timepoint_4d_yr1<- timepoint_4d_yr1[1:10,]
#timepoint_4d_yr1
detach(timepoint_4d_yr1)
```

#sorting timepoint_4d_2017 in decreasing order of Difference and selecting the first 10 from dataset.
```{r}
timepoint_4d_yr2<- timepoint_4d[timepoint_4d$Year== yr2,]
attach(timepoint_4d_yr2)
timepoint_4d_yr2<- timepoint_4d_yr2[order(-Difference),]
timepoint_4d_yr2<- timepoint_4d_yr2[1:10,]
#timepoint_4d_yr2
detach(timepoint_4d_yr2)
```

#sorting timepoint_2d_2016 in decreasing order of Difference and selecting the first 10 from the dataset.
```{r}
timepoint_2d <- df2[!grepl("\\-",df2$vGeneName,perl = TRUE),c("aminoAcid","vGeneName","Difference","Year")]
timepoint_2d_yr1<- timepoint_2d[timepoint_2d$Year== yr1,]
attach(timepoint_2d_yr1)
timepoint_2d_yr1<- timepoint_2d_yr1[order(-Difference),]
timepoint_2d_yr1<- timepoint_2d_yr1[1:10,]
# timepoint_2d_2016
detach(timepoint_2d_yr1)
```

#sorting timepoint_2d_2017 in decreasing order of Difference and selecting the first 50 from the dataset.
```{r}
timepoint_2d_yr2<- timepoint_2d[timepoint_2d$Year== yr2,]
attach(timepoint_2d_yr2)
timepoint_2d_yr2<- timepoint_2d_yr2[order(-Difference),]
timepoint_2d_yr2<- timepoint_2d_yr2[1:10,]
# timepoint_2d_2017
detach(timepoint_2d_yr2)
```

#creating heatmaps
```{r}
heatmaps<- function(df,str){
vGenes <- reshape::cast(cross_2d, aminoAcid ~ vGeneName, value = "Difference", sum)
rownames(vGenes) = as.character(vGenes$aminoAcid)
vGenes$aminoAcid = NULL
pheatmap(vGenes,labColumn =paste(colnames(vGenes),sep=""), fontsize=4, cexRow=0.5,col= colorRampPalette(brewer.pal(8, "RdYlBu"))(25),
         main = paste0("Heatmap shows the first ten CDR3 vs vGeneName(2-Digit) that has the highest absolute change from 2016 active(d7) to 2017 active(d7).\n") ,cellwidth=20,cellheight=7)
dev.copy2pdf(file=paste0(PATH1,"/heatmaps/","cross_reactive_2d.pdf"))
return
}
```


#creating heatmaps for cross-reactive and between time points.
```{r}
heatmaps(timepoint_4d_2016,"timepoint_4d_2016")
heatmaps(timepoint_4d_2017,"timepoint_4d_2017")
heatmaps(timepoint_2d_2016,"timepoint_2d_2016")
heatmaps(timepoint_2d_2017,"timepoint_2d_2017")
heatmaps(cross_4d,"Cross_Reactive_4d")
heatmaps(cross_2d,"Cross_Reactive_2d")
heatmaps(increase_cross_reactive,"Increased_Cross_Reactive")
heatmaps(increase_timepoint_4D,"Increased_btw_timepoint_4D")
heatmaps(increase_timepoint_2D,"Increased_btw_timepoint_2D")
```

